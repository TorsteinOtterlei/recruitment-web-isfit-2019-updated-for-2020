{% extends 'job/base.html' %}
{% load static %}
{% block head %}
    <link rel="stylesheet" type="text/css" href="{% static "job/application_form.css" %}">
{% endblock %}

{% block body %}
    <div class="container" style="color: black">
        <div class="row space-below">
            <div class="col-xl-12 space-above">
                <div class="white-box" id="text-box">
                    <h2>Your application</h2>
                    <form method="post">
                        {% csrf_token %}
                        {% for field in form %}
                        <p>
                            {{ field.label_tag }}<br>
                            {{ field }}
                            {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text }}</small>
                            {% endif %}
                            {% for error in field.errors %}
                                <p style="color: red">{{ error }}</p>
                            {% endfor %}
                        </p>
                        {% endfor %}

                        <!-- Lists available positions for each section/gang -->
                        <h3>Which positions do you want to apply for?</h3>
                        <p>A full list of the positions with all information can be found <a href="/information">here</a>.</p>

                          <div id="chooseDiv">
                            <div id="positionsDiv">
                              <h4>Gangs</h4>
                              {% for gang in gangs %}
                                  <div class="flex-horizontal">

                                      <h5 class="column-2">
                                        <a class="dropdown-toggle" data-toggle="collapse" href="#{{ gang.name }}"
                                          role="button" aria-expanded="false" aria-controls="collapseExample">
                                          {{ gang.name }}
                                        </a>
                                      </h5>

                                    <div class="positions-div collapse" id="{{ gang.name }}">
                                    <h5>Positions</h5>
                                    {% for position in positions %}

                                        {% if position.gang == gang %}
                                            <div class="flex-horizontal">
                                            <!--<input name="positions" id="{{ position.pk }}" type="checkbox" value="{{ position.pk }}"></input>
                                            <input name="rank" id="{{ ranking.pk }}" type="number" value="{{ ranking.pk }}"></input>-->
                                            <a class='positions' id='{{ position.title|cut:" "  }}' onclick="addChoice(this, '{{ position.title }}')">{{ position.title }}
                                            </a></div>
                                        {% endif %}

                                    {% endfor %}
                                    </div>
                                  </div>

                            {% endfor %}
                            </div>
                            <div id="rankingBox">
                              <div style="padding: 5px 5px 0 10px;">Your prioritised positions</div>
                              <div class="d-flex flex-column">
                                <div class="d-flex" id="firstChoice">
                                  <input type="button" class="chosen" value="">
                                  <input type="hidden" name="first" value="">
                                  <div class="ml-auto p-2 removeChoice" onclick="removeChoice(this)"></div>
                                </div>
                                <div class="d-flex" id="secondChoice">
                                  <input type="button" class="chosen" value="">
                                  <input type="hidden" name="second" value="">
                                  <div class="ml-auto p-2 removeChoice" onclick="removeChoice(this)"></div>
                                </div>
                                <div class="d-flex" id="thirdChoice">
                                  <input type="button" class="chosen" value="">
                                  <input type="hidden" name="third" value="">
                                  <div class="ml-auto p-2 removeChoice" onclick="removeChoice(this)"></div>
                                </div>
                              </div>
                            </div>
                          </div>

                        Have you prioriticed your choices?
                        <br><input onclick="des()" type="checkbox" name="prog" value="1" value="Yes" label="Yes">
                          <small style="display: inline-block;">Yes</small></input>
                        <div id="apply-text" style="margin-top: 10px;">
                          <h5>You have to prioritice your position choices before you can apply!</h5>
                        </div>
                        <button style="display: block; width: 100%; background-color: #007bff; color: white;" id="submit_prog" class="btn button-form" type="submit" >Apply</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scriptblock %}
    <script>
        $(document).ready(function() {

            var rankings = "{{applied_to}}".split(", ");
            console.log(rankings);
            for (var i = 0; i < rankings.length; i++) {
              cmd = "addChoice(document.getElementById('" + rankings[i].replace(/\s/g, '').split(".")[1]
                + "'), '" + rankings[i].split(". ")[1] + "')";
              setTimeout(cmd, 1);
              console.log(cmd)

            }



            //The three id's for the divs containing the user choices
            const ids = ['#firstChoice', '#secondChoice', '#thirdChoice']
            var div, nxtDiv;

            // Adding position to choices if it's not full already
            // Note: this is only front-end, nothing is added to the database
            function addChoice(elem, pos){
              if ($(ids[0]).find('input').first().val().split(')  ')[1] != pos &&
               $(ids[1]).find('input').first().val().split(')  ')[1] != pos){
                for (i = 0; i < ids.length; i++){
                  inp = $(ids[i]).find('input');
                  cross = $(ids[i]).find('div');
                  if (inp.first().val().length == 0){
                    inp.first().val((i+1).toString() + ")  " + pos);
                    inp.eq(1).val(pos);
                    inp.first().css("opacity", 1);
                    cross.first().html("X");
                    elem.style.color = "green";
                    break;
                  }
                }
              }
            }

            // Remove position
            function removeChoice(ch){
              inp = $(ch).parent().find('input');
              var id = inp.first().val().replace(/\s/g, '');
              $("#" + id.split(')')[1]).css("color", "black");
              inp.first().val("");
              inp.eq(1).val("");


              //Rotate positions up so the bottom one is open
              for (i = 0; i < ids.length - 1; i++){
                inp = $(ids[i]).find('input');
                nxtInp = $(ids[i+1]).find('input');
                if (inp.first().val().length == 0){
                  if (nxtInp.first().val().length != 0){
                    var pos = nxtInp.first().val().split(')  ')[1];
                    inp.first().val((i+1).toString() + ")  " + pos);
                    inp.eq(1).val(pos);
                  }
                  else{
                    inp.first().val( nxtInp.first().val() );
                    inp.eq(1).val( nxtInp.first().val().split(')  ')[1] );
                  }
                  nxtInp.first().val("");
                  nxtInp.eq(1).val("");
                }
              }
              for (i = 0; i < ids.length; i++){
                inp = $(ids[i]).find('input');
                cross = $(ids[i]).find('div');
                if (inp.first().val().length == 0){
                  cross.first().html("");
                  inp.first().css("opacity", 0);
                }
              }
            }
        });
    </script>
{% endblock %}
